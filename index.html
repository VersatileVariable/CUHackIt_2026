<!DOCTYPE html>
<!--
    ClearPath AR - Accessibility Wearable for Meta Quest 3
    
    DEPLOYMENT MODES:
    1. Cloud (Vercel/ngrok) - Speech, Audio, AI features only
    2. Local Network - All features including iPhone haptic feedback
    
    The app automatically detects deployment mode and disables
    iPhone bridge when accessed via public URLs.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ClearPath - AR Accessibility Wearable</title>
    
    <!-- A-Frame WebXR Framework -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- A-Frame WebXR Extras for AR -->
    <script src="https://cdn.jsdelivr.net/gh/supermedium/superframe@master/components/environment/dist/aframe-environment-component.min.js"></script>
    
    <!-- ClearPath AR Styles -->
    <link rel="stylesheet" href="css/ar-styles.css?v=2.2">
    
    <!-- ClearPath JavaScript Modules - Quest compatibility MUST load first -->
    <script src="js/quest-compatibility.js"></script>
    <script src="js/websocket-bridge.js"></script>
    <script src="js/speech-recognition.js"></script>
    <script src="js/audio-direction.js"></script>
    <script src="js/ai-summarizer.js"></script>
    <script src="js/ar-manager.js"></script>
    
    <script>
        // WebXR AR Configuration with Camera Access
        AFRAME.registerComponent('ar-mode', {
            init: function () {
                const sceneEl = this.el;
                
                // Enable AR mode and passthrough camera
                sceneEl.addEventListener('enter-vr', function () {
                    console.log('Entering AR mode - camera passthrough active');
                    document.body.classList.add('ar-active');
                    
                    // Request camera access for passthrough
                    const xrSession = sceneEl.xrSession;
                    if (xrSession) {
                        console.log('XR Session active - passthrough enabled');
                    }
                });
                
                sceneEl.addEventListener('exit-vr', function () {
                    console.log('Exiting AR mode');
                    document.body.classList.remove('ar-active');
                });
            }
        });
        
        // Quest passthrough helper
        AFRAME.registerComponent('quest-passthrough', {
            init: function() {
                const sceneEl = this.el.sceneEl;
                
                sceneEl.addEventListener('enter-vr', async () => {
                    const session = sceneEl.xrSession;
                    if (session && session.environmentBlendMode) {
                        console.log('XR Session Started');
                        console.log('   Blend Mode:', session.environmentBlendMode);
                        console.log('   Session Mode:', session.mode);
                        
                        // Request microphone permission for speech recognition
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            console.log('Microphone access granted');
                            // Stop the test stream, speech recognition will request again
                            stream.getTracks().forEach(track => track.stop());
                        } catch (err) {
                            console.error('Microphone access denied:', err);
                        }
                        
                        // Enable camera passthrough for Quest MR
                        if (session.environmentBlendMode === 'opaque') {
                            console.log('Opaque blend mode - passthrough may not work');
                        } else {
                            console.log('Quest passthrough active:', session.environmentBlendMode);
                        }
                        
                        // Make scene background truly transparent
                        const scene = sceneEl.object3D;
                        if (scene.background) {
                            scene.background = null;
                            console.log('Scene background cleared for passthrough');
                        }
                    }
                });
                
                sceneEl.addEventListener('exit-vr', () => {
                    console.log('Exited VR mode');
                });
            }
        });
    </script>
</head>
<body>
    <!-- WebXR DOM Overlay (required for UI elements in AR) -->
    <div id="overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
        <!-- Child elements with pointer-events: auto will be interactive -->
    </div>
    
    <!-- AR Scene Container -->
    <a-scene 
        embedded 
        webxr="requiredFeatures: local-floor; optionalFeatures: unbounded,dom-overlay,hand-tracking,layers; overlayElement: #overlay;"
        renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true; antialias: true; foveationLevel: 1;"
        vr-mode-ui="enabled: true; enterVRButton: #enterVRButton;"
        ar-mode
        quest-passthrough
    >
        <!-- Assets -->
        <a-assets>
            <!-- Fonts optimized for AR readability -->
            <a-mixin id="caption-font" 
                     text="font: roboto; 
                           color: #FFFFFF; 
                           shader: sdf; 
                           side: double;
                           opacity: 0.95;
                           align: center;
                           wrapCount: 40;
                           letterSpacing: 1;">
            </a-mixin>
            
            <a-mixin id="topic-font"
                     text="font: roboto;
                           color: #E8F4FD;
                           shader: sdf;
                           side: double;
                           opacity: 0.9;
                           align: left;
                           wrapCount: 25;
                           letterSpacing: 0;">
            </a-mixin>
            
            <a-mixin id="dashboard-font"
                     text="font: roboto;
                           color: #FFFFFF;
                           shader: sdf;
                           side: double;
                           opacity: 1.0;
                           align: left;
                           wrapCount: 35;
                           letterSpacing: 0;">
            </a-mixin>
        </a-assets>

        <!-- AR Camera with Passthrough -->
        <a-camera 
            id="arCamera"
            position="0 1.6 0"
            look-controls="enabled: true"
            wasd-controls="enabled: false"
            cursor="rayOrigin: mouse; fuse: true; fuseTimeout: 1500"
            raycaster="objects: .clickable"
        >
            <!-- VR Cursor Indicator -->
            <a-ring 
                position="0 0 -0.5" 
                radius-inner="0.01" 
                radius-outer="0.015" 
                color="#10B981" 
                opacity="0.8">
            </a-ring>
            <!-- 1. LIVE CAPTION BAR (Lower Third) -->
            <a-entity id="captionBar" position="0 -0.7 -1.5">
                <!-- Caption Background -->
                <a-box 
                    id="captionBg"
                    position="0 0 0"
                    width="3.0"
                    height="0.35"
                    depth="0.01"
                    color="#1F2937"
                    opacity="0.95"
                    visible="true">
                </a-box>
                
                <!-- Caption Text -->
                <a-text 
                    id="captionText"
                    text="font: roboto; 
                          color: #FFFFFF; 
                          shader: sdf; 
                          side: double;
                          opacity: 1.0;
                          align: center;
                          wrapCount: 70;
                          letterSpacing: 0;
                          baseline: center;
                          value: Captions will be added here;"
                    position="0 0 0.02"
                    width="2.8"
                    visible="true">
                </a-text>
            </a-entity>

            <!-- 2. 360-DEGREE DIRECTIONAL SOUND INDICATORS -->
            <!-- Sound Ring Container - Positioned around user -->
            <a-entity id="soundRing" position="0 0 -1.5">
                <!-- North (0¬∞) -->
                <a-box id="soundN" position="0 1.5 0" width="0.2" height="0.3" depth="0.02" 
                       color="#00FFFF" opacity="0" material="transparent: true; emissive: #00FFFF; emissiveIntensity: 0"></a-box>
                
                <!-- Northeast (45¬∞) -->
                <a-box id="soundNE" position="1.06 1.06 0" width="0.15" height="0.25" depth="0.02" 
                       color="#00FF80" opacity="0" material="transparent: true; emissive: #00FF80; emissiveIntensity: 0"></a-box>
                
                <!-- East (90¬∞) -->
                <a-box id="soundE" position="1.5 0 0" width="0.3" height="0.2" depth="0.02" 
                       color="#00FF00" opacity="0" material="transparent: true; emissive: #00FF00; emissiveIntensity: 0"></a-box>
                
                <!-- Southeast (135¬∞) -->
                <a-box id="soundSE" position="1.06 -1.06 0" width="0.15" height="0.25" depth="0.02" 
                       color="#80FF00" opacity="0" material="transparent: true; emissive: #80FF00; emissiveIntensity: 0"></a-box>
                
                <!-- South (180¬∞) -->
                <a-box id="soundS" position="0 -1.5 0" width="0.2" height="0.3" depth="0.02" 
                       color="#FFFF00" opacity="0" material="transparent: true; emissive: #FFFF00; emissiveIntensity: 0"></a-box>
                
                <!-- Southwest (225¬∞) -->
                <a-box id="soundSW" position="-1.06 -1.06 0" width="0.15" height="0.25" depth="0.02" 
                       color="#FF8000" opacity="0" material="transparent: true; emissive: #FF8000; emissiveIntensity: 0"></a-box>
                
                <!-- West (270¬∞) -->
                <a-box id="soundW" position="-1.5 0 0" width="0.3" height="0.2" depth="0.02" 
                       color="#FF0000" opacity="0" material="transparent: true; emissive: #FF0000; emissiveIntensity: 0"></a-box>
                
                <!-- Northwest (315¬∞) -->
                <a-box id="soundNW" position="-1.06 1.06 0" width="0.15" height="0.25" depth="0.02" 
                       color="#FF0080" opacity="0" material="transparent: true; emissive: #FF0080; emissiveIntensity: 0"></a-box>
                
                <!-- Central Sound Intensity Ring -->
                <a-ring id="centralRing" position="0 0 0.1" 
                        radius-inner="0.8" radius-outer="1.0" 
                        color="#FFFFFF" opacity="0" 
                        material="transparent: true; emissive: #FFFFFF; emissiveIntensity: 0">
                </a-ring>
            </a-entity>

            <!-- 3. TOPIC BOX (Center) -->
            <a-entity id="topicBox" position="0 -0.15 -1.5">
                <!-- Topic Background -->
                <a-box 
                    id="topicBg"
                    position="0 0 0"
                    width="2.2"
                    height="0.3"
                    depth="0.01"
                    color="#1F2937"
                    opacity="0.95"
                    visible="false">
                </a-box>
                
                <!-- Topic Content -->
                <a-text 
                    id="topicContent"
                    mixin="topic-font"
                    position="0 0 0.01"
                    value="Topic of conversation"
                    width="2.0"
                    color="#FFFFFF"
                    align="center"
                    visible="false">
                </a-text>
            </a-entity>

            <!-- 4. DASHBOARD PANEL (Right Side) -->
            <a-entity id="dashboardPanel" position="1.1 0.0 -1.8">
                <!-- Dashboard Background -->
                <a-box 
                    id="dashboardBg"
                    position="0 0 0"
                    width="1.8"
                    height="0.5"
                    depth="0.01"
                    color="#1F2937"
                    opacity="0.95"
                    visible="true">
                </a-box>
                
                <!-- Person Name -->
                <a-text 
                    id="dashboardName"
                    text="font: roboto;
                          color: #FFFFFF;
                          shader: sdf;
                          side: double;
                          opacity: 1.0;
                          align: left;
                          wrapCount: 35;
                          letterSpacing: 0;
                          value: Person's Name: ...;"
                    position="-0.85 0.15 0.02"
                    width="1.6"
                    visible="true">
                </a-text>
                
                <!-- Relationship -->
                <a-text 
                    id="dashboardRelation"
                    text="font: roboto;
                          color: #E5E7EB;
                          shader: sdf;
                          side: double;
                          opacity: 1.0;
                          align: left;
                          wrapCount: 35;
                          letterSpacing: 0;
                          value: Relationship: ...;"
                    position="-0.85 -0.15 0.02"
                    width="1.6"
                    visible="true">
                </a-text>
            </a-entity>

            <!-- 5. AR MODE TOGGLES (Left Side Vertical) -->
            <a-entity id="arToggles" position="-1.3 0.1 -1.8">
                <!-- Toggle Background -->
                <a-box 
                    position="0 0 0"
                    width="0.9"
                    height="0.8"
                    depth="0.01"
                    color="#1F2937"
                    opacity="0.95">
                </a-box>
                
                <!-- Caption Toggle -->
                <a-box 
                    id="captionToggleBox"
                    position="-0.3 0.25 0.02"
                    width="0.15"
                    height="0.1"
                    depth="0.01"
                    color="#10B981"
                    opacity="1.0"
                    class="clickable ar-toggle">
                </a-box>
                <a-text 
                    value="Captions: on"
                    position="0.05 0.25 0.02"
                    width="0.9"
                    align="left"
                    color="#FFFFFF"
                    font="roboto">
                </a-text>
                
                <!-- Topic Toggle -->
                <a-box 
                    id="topicToggleBox"
                    position="-0.3 0.0 0.02"
                    width="0.15"
                    height="0.1"
                    depth="0.01"
                    color="#6366F1"
                    opacity="1.0"
                    class="clickable ar-toggle">
                </a-box>
                <a-text 
                    value="Topic: on"
                    position="0.05 0.0 0.02"
                    width="0.9"
                    align="left"
                    color="#FFFFFF"
                    font="roboto">
                </a-text>
                
                <!-- Haptics Toggle -->
                <a-box 
                    id="hapticsToggleBox"
                    position="-0.3 -0.25 0.02"
                    width="0.15"
                    height="0.1"
                    depth="0.01"
                    color="#F59E0B"
                    opacity="1.0"
                    class="clickable ar-toggle">
                </a-box>
                <a-text 
                    value="Haptics: on"
                    position="0.05 -0.25 0.02"
                    width="0.9"
                    align="left"
                    color="#FFFFFF"
                    font="roboto">
                </a-text>
            </a-entity>

            <!-- Status Indicator (for debugging) -->
            <a-text 
                id="statusText"
                position="0 -0.5 -1.2"
                value="ClearPath Loading..."
                color="#10B981"
                width="2.5"
                align="center"
                visible="true">
            </a-text>
        </a-camera>

        <!-- Ambient lighting for AR -->
        <a-light type="ambient" color="#404040" intensity="0.5"></a-light>
    </a-scene>

    <!-- AR Control Panel -->
    <div id="arControls" class="ar-controls">
        <div class="control-header">ClearPath Controls</div>
        
        <!-- Primary Action -->
        <button id="enterVRButton" class="ar-button vr-btn">ü•Ω Enter AR Mode</button>
        
        <!-- Feature Controls -->
        <button id="toggleSpeech" class="ar-button speech-btn">üé§ Speech Recognition</button>
        <button id="toggleAudio" class="ar-button audio-btn">üîä Audio Direction</button>
        <button id="toggleAI" class="ar-button ai-btn">ü§ñ AI Topics</button>
        
        <!-- System Status -->
        <div id="systemStatus" class="status-panel">
            <div id="speechStatus" class="status-item">üé§ Speech: Ready</div>
            <div id="audioStatus" class="status-item">üîä Audio: Ready</div>
            <div id="aiStatus" class="status-item">ü§ñ AI: Ready</div>
            <div id="bridgeStatus" class="status-item">üîå Bridge: Connecting...</div>
        </div>
        
        <!-- Network Mode Info Banner (shows when via ngrok) -->
        <div id="networkInfo" style="display:none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(250, 204, 21, 0.95); color: #000; padding: 10px 20px; border-radius: 8px; font-size: 14px; z-index: 10000; max-width: 90%; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
            <strong>üåê Public Access Mode</strong><br>
            <span style="font-size: 12px;">iPhone haptics unavailable ‚Ä¢ For full features use: https://172.22.53.62:5500</span>
        </div>
        
        <!-- Test Button (subtle) -->
        <button id="testCaption" class="ar-button test-btn">Test Captions</button>
    </div>

    <script>
        // Initialize ClearPath AR System on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ClearPath AR System Starting...');
            
            // Load user configuration from localStorage or setup
            loadUserConfiguration();
            
            // Initialize WebSocket bridge to laptop
            if (window.bridgeModule) {
                // Check if we're accessing via ngrok (public tunnel)
                const isNgrokOrPublic = window.location.hostname.includes('ngrok') || 
                                       window.location.hostname.includes('loca.lt') ||
                                       window.location.hostname.includes('vercel') ||
                                       window.location.hostname.includes('netlify') ||
                                       !window.location.hostname.match(/^192\.|^172\.|^10\.|localhost/);
                
                if (isNgrokOrPublic) {
                    console.log('üåê Public deployment mode - Bridge connection disabled');
                    console.log('üì± Speech, Audio, and AI features available in headset');
                    console.log('‚ÑπÔ∏è  iPhone haptic feedback requires local network deployment');
                    // Update status to show bridge is intentionally disabled
                    setTimeout(() => {
                        const statusEl = document.getElementById('bridgeStatus');
                        if (statusEl) {
                            statusEl.textContent = 'üîå Bridge: Not available (deployed)';
                            statusEl.classList.add('warning');
                        }
                    }, 1000);
                } else {
                    console.log('Initializing WebSocket bridge...');
                    // Set laptop IP address - update this if your network changes
                    window.bridgeModule.setServerAddress('ws://172.22.53.62:8080');
                    // Connect to bridge server
                    window.bridgeModule.connect();
                }
            } else {
                console.error('Bridge module not loaded!');
            }
            
            // Initialize all AR layers
            initializeDirectionalIndicators();
            initializeCaptionSystem();
            initializeTopicSystem();
            initializeDashboard();
            
            // Set up UI event listeners
            setupUIControls();
            
            // Update status
            updateStatusText('ClearPath Ready - Tap buttons to activate features');
            
            console.log('ClearPath AR System Ready!');
        });

        // Load user configuration
        function loadUserConfiguration() {
            const config = JSON.parse(localStorage.getItem('clearpath-config') || '{}');
            
            if (config.personName) {
                updateDashboard(config.personName, config.relationship);
                console.log('Loaded user configuration:', config);
            } else {
                console.log('No configuration found - using defaults');
                updateDashboard('Listening...', 'Auto-detects from speech');
            }
        }

        // Update dashboard information (notes section removed)
        function updateDashboard(name, relationship) {
            const nameEl = document.getElementById('dashboardName');
            const relationEl = document.getElementById('dashboardRelation');
            
            if (nameEl) nameEl.setAttribute('value', `Person: ${name}`);
            if (relationEl) relationEl.setAttribute('value', `Relationship: ${relationship}`);
        }

        // Initialize directional sound indicators
        function initializeDirectionalIndicators() {
            console.log('Initializing directional indicators...');
            // This will be expanded by audio-direction.js
        }

        // Initialize live captions
        function initializeCaptionSystem() {
            console.log('Initializing caption system...');
            // This will be expanded by speech-recognition.js
        }

        // Initialize topic conversation system
        function initializeTopicSystem() {
            console.log('Initializing topic system...');
            // This will be expanded by ai-summarizer.js
        }

        // Initialize dashboard
        function initializeDashboard() {
            console.log('Initializing dashboard...');
            // Dashboard is already visible and populated
        }

        // Set up UI control event listeners
        function setupUIControls() {
            // AR Toggle Handlers (for in-VR interaction)
            const captionToggle = document.getElementById('captionToggleBox');
            const topicToggle = document.getElementById('topicToggleBox');
            const hapticsToggle = document.getElementById('hapticsToggleBox');
            
            if (captionToggle) {
                captionToggle.addEventListener('click', function() {
                    const captionBar = document.getElementById('captionBar');
                    const isVisible = captionBar.getAttribute('visible') !== 'false';
                    captionBar.setAttribute('visible', !isVisible);
                    captionToggle.setAttribute('opacity', !isVisible ? '1.0' : '0.4');
                    
                    // Update toggle text
                    const textEl = captionToggle.nextElementSibling;
                    if (textEl && textEl.tagName === 'A-TEXT') {
                        textEl.setAttribute('value', !isVisible ? 'Captions: on' : 'Captions: off');
                    }
                    console.log('Captions toggled:', !isVisible);
                });
            }
            
            if (topicToggle) {
                topicToggle.addEventListener('click', function() {
                    const topicBox = document.getElementById('topicBox');
                    const isVisible = topicBox.getAttribute('visible') !== 'false';
                    topicBox.setAttribute('visible', !isVisible);
                    topicToggle.setAttribute('opacity', !isVisible ? '1.0' : '0.4');
                    
                    // Update toggle text
                    const textEl = topicToggle.nextElementSibling;
                    if (textEl && textEl.tagName === 'A-TEXT') {
                        textEl.setAttribute('value', !isVisible ? 'Topic: on' : 'Topic: off');
                    }
                    console.log('Topics toggled:', !isVisible);
                });
            }
            
            if (hapticsToggle) {
                hapticsToggle.addEventListener('click', function() {
                    const isEnabled = hapticsToggle.getAttribute('data-enabled') !== 'false';
                    hapticsToggle.setAttribute('data-enabled', !isEnabled);
                    hapticsToggle.setAttribute('opacity', !isEnabled ? '1.0' : '0.4');
                    
                    // Update toggle text
                    const textEl = hapticsToggle.nextElementSibling;
                    if (textEl && textEl.tagName === 'A-TEXT') {
                        textEl.setAttribute('value', !isEnabled ? 'Haptics: on' : 'Haptics: off');
                    }
                    
                    // Set global haptics flag for haptic feedback system
                    window.hapticsEnabled = !isEnabled;
                    console.log('Haptics toggled:', !isEnabled);
                });
            }
            
            // Test Caption Button
            document.getElementById('testCaption').addEventListener('click', function() {
                const testText = 'Test caption - if you can read this, captions work!';
                window.updateCaption(testText);
                console.log('Test caption displayed');
                
                // Auto-hide after 3 seconds
                setTimeout(() => {
                    window.updateCaption('');
                }, 3000);
            });
            
            // Enter VR Button
            document.getElementById('enterVRButton').addEventListener('click', function() {
                const sceneEl = document.querySelector('a-scene');
                if (sceneEl) {
                    sceneEl.enterVR();
                    console.log('Entering VR/AR mode...');
                }
            });
            
            // Speech Recognition Toggle
            document.getElementById('toggleSpeech').addEventListener('click', async function() {
                // Request microphone permission first
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('Microphone permission granted');
                    
                    if (window.speechModule) {
                        window.speechModule.toggle();
                    } else {
                        console.error('Speech module not loaded');
                    }
                } catch (err) {
                    console.error('Microphone permission denied:', err);
                    alert('Microphone access is required for speech recognition. Please enable microphone permissions in your browser settings.');
                }
            });

            // Audio Direction Toggle
            document.getElementById('toggleAudio').addEventListener('click', function() {
                if (window.audioModule) {
                    window.audioModule.toggle();
                } else {
                    console.error('Audio module not loaded');
                }
            });

            // AI Summarization Toggle
            document.getElementById('toggleAI').addEventListener('click', function() {
                if (window.aiModule) {
                    window.aiModule.toggle();
                } else {
                    console.error('AI module not loaded');
                }
            });
        }

        // Update status text in AR view
        function updateStatusText(message) {
            const statusEl = document.getElementById('statusText');
            if (statusEl) {
                statusEl.setAttribute('value', message);
            }
            console.log('Status:', message);
        }

        // Trigger 360-degree directional glow (called by audio-direction.js)
        window.triggerDirectionalGlow = function(angle, intensity = 0.8, duration = 1500, soundType = 'speech') {
            // Determine which indicator to activate based on angle (0-360 degrees)
            let indicatorId = '';
            let color = '#FFFFFF';
            
            if (angle >= 337.5 || angle < 22.5) {
                indicatorId = 'soundN'; color = '#00FFFF'; // North - Cyan
            } else if (angle >= 22.5 && angle < 67.5) {
                indicatorId = 'soundNE'; color = '#00FF80'; // Northeast - Cyan-Green
            } else if (angle >= 67.5 && angle < 112.5) {
                indicatorId = 'soundE'; color = '#00FF00'; // East - Green
            } else if (angle >= 112.5 && angle < 157.5) {
                indicatorId = 'soundSE'; color = '#80FF00'; // Southeast - Yellow-Green
            } else if (angle >= 157.5 && angle < 202.5) {
                indicatorId = 'soundS'; color = '#FFFF00'; // South - Yellow
            } else if (angle >= 202.5 && angle < 247.5) {
                indicatorId = 'soundSW'; color = '#FF8000'; // Southwest - Orange
            } else if (angle >= 247.5 && angle < 292.5) {
                indicatorId = 'soundW'; color = '#FF0000'; // West - Red
            } else if (angle >= 292.5 && angle < 337.5) {
                indicatorId = 'soundNW'; color = '#FF0080'; // Northwest - Magenta
            }
            
            const indicator = document.getElementById(indicatorId);
            const centralRing = document.getElementById('centralRing');
            
            if (indicator) {
                // Activate directional indicator
                indicator.setAttribute('opacity', intensity);
                indicator.setAttribute('material', `transparent: true; emissive: ${color}; emissiveIntensity: ${intensity}`);
                
                // Scale based on intensity
                const scale = 1 + (intensity * 0.5);
                indicator.setAttribute('scale', `${scale} ${scale} 1`);
                
                // Activate central ring for overall sound awareness
                if (centralRing) {
                    centralRing.setAttribute('opacity', intensity * 0.3);
                    centralRing.setAttribute('material', `transparent: true; emissive: ${color}; emissiveIntensity: ${intensity * 0.3}`);
                }
                
                // Fade out after duration
                setTimeout(() => {
                    indicator.setAttribute('opacity', 0);
                    indicator.setAttribute('material', `transparent: true; emissive: ${color}; emissiveIntensity: 0`);
                    indicator.setAttribute('scale', '1 1 1');
                    
                    if (centralRing) {
                        centralRing.setAttribute('opacity', 0);
                        centralRing.setAttribute('material', 'transparent: true; emissive: #FFFFFF; emissiveIntensity: 0');
                    }
                }, duration);
                
                console.log(`360¬∞ Sound at ${Math.round(angle)}¬∞ with intensity ${intensity.toFixed(2)}`);
            }
        };

        // Update captions (called by speech-recognition.js)
        window.updateCaption = function(text) {
            const captionText = document.getElementById('captionText');
            const captionBg = document.getElementById('captionBg');
            
            console.log('updateCaption called with:', text);
            
            if (captionText && captionBg) {
                if (text && text.trim()) {
                    console.log('Setting caption text to:', text);
                    
                    // Set the text component's value property
                    captionText.setAttribute('text', 'value', text);
                    captionText.setAttribute('visible', true);
                    captionBg.setAttribute('visible', true);
                    
                    console.log('Caption text set successfully');
                } else {
                    // Show placeholder instead of hiding
                    captionText.setAttribute('text', 'value', 'Captions will be added here');
                    captionText.setAttribute('visible', true);
                    captionBg.setAttribute('visible', true);
                }
            } else {
                console.error('Caption elements not found!');
            }
        };

        // Update topic (called by ai-summarizer.js)
        window.updateTopic = function(topic) {
            const topicContent = document.getElementById('topicContent');
            const topicBg = document.getElementById('topicBg');
            
            if (topicContent && topicBg) {
                if (topic && topic.trim()) {
                    topicContent.setAttribute('value', topic);
                    topicContent.setAttribute('visible', true);
                    topicBg.setAttribute('visible', true);
                } else {
                    // Show placeholder instead of hiding
                    topicContent.setAttribute('value', 'Topic of conversation');
                    topicContent.setAttribute('visible', true);
                    topicBg.setAttribute('visible', true);
                }
                
                console.log('Topic updated:', topic);
            } else {
                console.error('Topic elements not found!');
            }
        };
        };

        // Global error handling for AR
        window.addEventListener('error', function(e) {
            console.error('ClearPath AR Error:', e.error);
            updateStatusText('Error: ' + e.error.message);
        });

        // XR session management
        if (navigator.xr) {
            navigator.xr.isSessionSupported('immersive-ar').then(function(supported) {
                if (supported) {
                    console.log('WebXR AR supported');
                    updateStatusText('ClearPath Ready - WebXR AR Available');
                } else {
                    console.warn('WebXR AR not supported');
                    updateStatusText('Warning: WebXR AR not supported on this device');
                }
            });
        } else {
            console.warn('WebXR not available');
            updateStatusText('Warning: WebXR not available - use Meta Quest 3 browser');
        }
    </script>
</body>
</html>